<!DOCTYPE html>
<html>
<head>
    <title>Movie OTT Finder</title>

    <!-- Bootstrap CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #121212;
            color: white;
        }

        .suggestion-box {
            max-height: 250px;
            overflow-y: auto;
        }

        .list-group-item {
            cursor: pointer;
        }

        .list-group-item:hover {
            background-color: #343a40;
            color: white;
        }
    </style>
</head>

<body>

<div class="container py-5">

    <h1 class="text-center mb-4">üé¨ Movie & Series OTT Finder</h1>

    <!-- üîç SEARCH FORM WITH AUTOCOMPLETE -->
    <form method="POST" class="d-flex justify-content-center mb-5 position-relative">
        
        <div class="w-50 position-relative">
            <input type="text"
                   name="movie"
                   id="movieInput"
                   class="form-control"
                   placeholder="Enter movie or series name"
                   autocomplete="off"
                   required>

            <div id="suggestions"
                 class="list-group position-absolute w-100 suggestion-box"
                 style="z-index: 1000;"></div>
        </div>

        <button type="submit" class="btn btn-primary ms-2">Search</button>
    </form>

    <!-- üé¨ MOVIE RESULT -->
    {% if movie %}
    <div class="card bg-secondary text-light shadow-lg">
        <div class="row g-0">

            {% if movie.poster %}
            <div class="col-md-4">
                <img src="{{ movie.poster }}" class="img-fluid rounded-start">
            </div>
            {% endif %}

            <div class="col-md-8">
                <div class="card-body">

                    <h3 class="card-title">{{ movie.title }}</h3>

                    {% if movie.is_released and movie.rating and movie.rating > 0 %}
                    <p class="badge bg-warning text-dark">
                        ‚≠ê IMDb Rating: {{ movie.rating }}
                    </p>
                    {% endif %}
                    <p class="card-text mt-3">
                        {{ movie.overview }}
                    </p>

                    <hr>

                    {% if not movie.is_released %}
                        <h5>üìÖ Release Date:</h5>
                        <p class="text-info fs-5">
                            {{ movie.release_date }}
                        </p>

                    {% else %}
                        <h5>üì∫ Available On (India):</h5>

                        {% if movie.providers %}
                            <div class="d-flex flex-wrap gap-2 mt-2">
                                {% for provider in movie.providers %}
                                    <span class="badge bg-info text-dark p-2">
                                        {{ provider.provider_name }}
                                    </span>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-danger mt-2">
                                Not currently available on OTT platforms.
                            </p>
                        {% endif %}
                    {% endif %}

                </div>
            </div>

        </div>
    </div>
    {% endif %}

</div>

<!-- üî• AUTOCOMPLETE SCRIPT -->
<script>
const input = document.getElementById("movieInput");
const suggestionsBox = document.getElementById("suggestions");

let timeout = null;

input.addEventListener("keyup", function() {

    clearTimeout(timeout);

    let query = input.value;

    if (query.length < 2) {
        suggestionsBox.innerHTML = "";
        return;
    }

    // Debounce to prevent too many API calls
    timeout = setTimeout(() => {

        fetch(`/autocomplete?q=${query}`)
            .then(response => response.json())
            .then(data => {

                suggestionsBox.innerHTML = "";

                data.forEach(item => {

                    let option = document.createElement("a");
                    option.classList.add("list-group-item", "list-group-item-action");
                    option.textContent = item;

                    option.onclick = function() {
                        input.value = item;
                        suggestionsBox.innerHTML = "";
                    };

                    suggestionsBox.appendChild(option);
                });
            });

    }, 300); // wait 300ms after typing
});

// Close dropdown if clicking outside
document.addEventListener("click", function(e) {
    if (!input.contains(e.target)) {
        suggestionsBox.innerHTML = "";
    }
});
</script>

</body>
</html>